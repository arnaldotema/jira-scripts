# Analytics | Warm Transferred Calls 

**JPD ID:** [RD-731](https://cloudtalk.atlassian.net//browse/RD-731)

---

## Summary

WHAT
Support transferred calls in new Analytics reports. We will make it clear when a call was transferred, who handled it, and combine the call data (like talk time or wrap-up time) so it reflects the full picture. This includes both what users see in reports and in the call details. Transferred calls will finally be tracked and reported properly.
WHY
Right now, transferred calls are not handled in the new Analytics. This leads to missing data in reports and confuses users - especially when int...

## Effort

**Story Points:** 50

**Estimated Sprints:** 2

## Discovery Ballpark

1

## Release ETA

**Target Sprint:** Sprint 4

**Estimated Date:** 2025-12-31

*(Based on JPD position 2 of 10 in cycle)*

## Technical Complexity

Here is a summary of the key technical details and implementation complexity for the Analytics | Warm Transferred Calls project (JPD RD-731):

The main technical changes required are:

1. Correctly processing and storing data for warm transferred calls in the backend systems, including the Call Information Processing (CIP) service and the Statistics API. This involves properly linking the original inbound/outbound call with the internal transferred call, and capturing the relevant call metadata like talking time, call steps, and recording IDs. (Tickets DSH-5655, DSH-5633, DSH-5625)

2. Updating the frontend Analytics UI to properly visualize and present the data for warm transferred calls across the various call tables and call detail pages. This includes displaying the linked internal call, recording playback, and other relevant details. (Tickets DSH-5626, DSH-5653, DSH-5792)

The key services and components impacted are the CIP, Statistics API, and the Analytics frontend. This work is considered complex due to the need to properly link and process the data across multiple call records, as well as ensure consistent visualization and behavior across the various Analytics views.

Some notable technical challenges include accurately calculating and displaying the correct talking time for warm transferred calls, handling multi-hop warm transfers in the future, and ensuring the right level of permissions and access to call recordings. Thorough end-to-end testing will also be critical to validate the end-to-end functionality. (Tickets DSH-6308, DSH-5792, DSH-5793)

Overall, this project requires coordinated changes across the backend and frontend to ensure the warm transferred calls feature is fully implemented with the right level of data fidelity and user experience.

<details>
<summary>View detailed technical breakdown</summary>

### [DSH-6308: CIP - inbound transfer talking time](https://cloudtalk.atlassian.net//browse/DSH-6308)

**Type:** Bug

*What happened?*

{quote}Call generated by transferring to internal agent has call step “call to agent” with wrong talking time.

Talking time seems to include ringing time + talking time and shows ringing time as empty.

Talking time is shown correctly in dashboard table or call logs table, it’s only wrong for call step when you open call steps modal table.

Value likely generated here [https://github.com/CloudTalk-io/call-information-processing/blob/df84e91c51a634df01e5abf489aa26f873ebf354/src/app/statistics/processing/call-ended/call-ended.service.ts#L403|https://github.com/CloudTalk-io/call-information-processing/blob/df84e91c51a634df01e5abf489aa26f873ebf354/src/app/statistics/processing/call-ended/call-ended.service.ts#L403] {quote}

*How to reproduce? Step by step.*

{quote}During call transfer to internal agent and pick the call up on that internal agent.

Compare talking time in call log table and in call steps table in analytics.{quote}

*Expected behavior?*

{quote}Times match in call log and call steps.{quote}

*Additional data:*

Company ID: 100552

Environment: dev

call id: 258608874

!Screen Recording 2025-10-06 at 11.51.33.mov|width=1920,height=1008,alt="Screen Recording 2025-10-06 at 11.51.33.mov"!



‌

---

### [DSH-5655: [BE] Warm transferred calls](https://cloudtalk.atlassian.net//browse/DSH-5655)

**Type:** Story

* {{call-information-processing}}
** inbound/outbound call record is already being stored in mongodb
*** newly redis call logs hold info about related call (implemented in [https://cloudtalk.atlassian.net/browse/VOIP-1955|https://cloudtalk.atlassian.net/browse/VOIP-1955|smart-link] ) so the linkage with internal call ID is possible and should be stored in mongodb in a new call document property (taken from {{"call_warm_transfer_uuid::1747752594.347563500::30389162-d639-44f3-8d75-acc5be35c0a6"}} which refers to internal call UUID {{30389162-d639-44f3-8d75-acc5be35c0a6}}) as array to support multi-hop in the future
*** store status: {{warm_transfer}} to call step which started warm transfer
*** change existing {{type:transferred}}to {{warm_transfer}} so FE can vi

---

### [DSH-5655 (comment by Arnaldo Tema)](https://cloudtalk.atlassian.net//browse/DSH-5655 (comment by Arnaldo Tema))

**Type:** Story

Dashboard Team (        )to read this and comment about the proposed estimates. Bear in mind tests, e2e tests and normal business flow


---

### [DSH-5655 (comment by Arnaldo Tema)](https://cloudtalk.atlassian.net//browse/DSH-5655 (comment by Arnaldo Tema))

**Type:** Story

 will split this into multiple user stories with their respective story points.


---

### [DSH-5633: [BE] AN call tables inbound cold transfer](https://cloudtalk.atlassian.net//browse/DSH-5633)

**Type:** Story

*ED*

* linkage of calls available by {{asterisk_cdr.call_uuid}}
* both calls {{asterisk_cdr.type: incoming}}
* cip already process those 2 call records but without linkage as separated calls:
!Screenshot 2025-05-22 at 13.58.07.png|width=88.90487149980821%,alt="Screenshot 2025-05-22 at 13.58.07.png"!

* {{cip}}:
** adjust current processing of 2 calls representing inbound cold transferred call (they have the same redis log, just different {{cdr_id}}) to:
*** just the second call will be processed (first one will be ignored - skip first logic is already [implemented|https://github.com/CloudTalk-io/call-information-processing/blob/main/src/app/statistics/processing/call-ended/call-ended.service.ts#L193]) and will contain:
**** {{direction: inbound}}
**** {{type: cold_transfer}}
**** {{call steps as usual agents/ivrs/groups/etc}} + {{agent step}} of agent who did the transfer having status {{cold_transfer}} and agent who received transfer will have {{status: answered}}
**** deduct proper call times from call log if possible otherwise from MariaDB related records (both)
***** call times in {{call}} document root will contain sums of times from both cdr_ids
** update call document validation schema and apply by GHA
** dev unit tests
* {{statistics-api}}
** agent and group reports should work w/o changes based on call_steps based filtering
** ensure new call type {{cold_transfer}} is served properly to FE including new call step with status {{cold_transfer}}
** enhance {{enrichCallLogsWithAgents}} to return {{user}} as an array considering also agent steps with {{cold_transfer}} as valid object
*** also {{enrichAgentCallLogsWithAgents}} needs to be tweaked to return array as well
** dev e2e tests
* examples on dev env:
{noformat}# cold transferred inbound
SELECT * FROM asterisk_cdr WHERE id IN (258494021,258494022);{noformat}

Grooming note:

* exports are fetching agents differently using it’s [own aggregation|https://github.com/CloudTalk-io/statistics-api/blob/2e158181af37d9d8afa46d460fbadfa08b3405b2/src/export/processor/export.aggregationts.ts#L66] and requires it’s own tweak (requires separated story)
* this story won’t enhance exports and they will hold just the Agent which ended the call (cc [~accountid:712020:c4042f51-1ace-4596-b57e-e9f6b4ad043d]  - pls raise a hand if we want to fully support exports as well)

---

### [DSH-5633 (comment by Roman Hartig)](https://cloudtalk.atlassian.net//browse/DSH-5633 (comment by Roman Hartig))

**Type:** Story

ensure completed redis call log is used to cover this ticket  


---

### [DSH-5625: [BE] AN call tables outbound cold transfer](https://cloudtalk.atlassian.net//browse/DSH-5625)

**Type:** Story

*ED*

* linkage of calls available by {{asterisk_cdr.call_uuid}}
* original call {{asterisk_cdr.type: outgoing}}
* transferred call {{asterisk_cdr.type: internal}}
** this call doesn’t have supported call log from redis so {{cip}} processing is failing on it ({{Missing begin and call_end in call log}})
{noformat}{
  "uuid": "08e466c0-57a9-451a-95fa-13c0f55b00ac",
  "cdrId": 258494029,
  "logs": [
    "call_transfer_enter::1746518774.505693773::100773011005&100773021005&100773031005",
    "call_transfer_exit::1746518786.052962150::answered"
  ]
}{noformat}
* {{cip}}
** adjust calls processing to allow this simplified log from above and use the same “merging” calls logic as proposed in inbound cold transfer in [https://cloudtalk.atlassian.net/browse/DSH-5633|https://cloudtalk.atlassian.net/browse/DSH-5633|smart-link] 
*** + add new {{calls.recordingsCallIds = [ <first_cdr_id>, <second_cdr_id_if_outbound_cold_transfer>]}} property providing IDs to fetch recordings by FE
** dev unit test
* {{statistics-api}}
** adjust {{calls.recordingsCallIds}} array to contain only {{cdr_id}}’s which are accesible by current user and set {{call.recorded: true}} only if array is not empty
** dev e2e tests
* examples on {{dev}} env:
{noformat}# cold transferred outbound
SELECT * FROM asterisk_cdr WHERE id IN (258494028,258494029);{noformat}

Note: double check proper adjustment of internal calls exclusion from [https://cloudtalk.atlassian.net/browse/DSH-5982|https://cloudtalk.atlassian.net/browse/DSH-5982|smart-link] 

---

### [DSH-5626: [FE] AN call tables inbound cold transfer](https://cloudtalk.atlassian.net//browse/DSH-5626)

**Type:** Story

*ED*

* apply new visualization from [figma|https://www.figma.com/design/4Cm1MRoC0xv2l0im2BZ0FZ/WIP-Analytics?node-id=5413-22361&t=UwMoxpRyAEh9CWrE-0] to calls with new {{type: cold_transfer}} on agent/group reports/Tag/AI analytics and call log

!Screenshot 2025-05-22 at 14.16.15.png|width=88.90487149980821%,alt="Screenshot 2025-05-22 at 14.16.15.png"!

* treat {{user}} property (from {{total-calls}} endpoint response) newly as an array instead of object holding list of objects defining Agents participating in transferred call (all non-transferred calls will have just one object in the array
** change {{via}} column to show all agents from {{user}} property

---

### [DSH-5642: [QA] AN inbound cold transfer e2e tests](https://cloudtalk.atlassian.net//browse/DSH-5642)

**Type:** Story

* consider writing e2e tests
** create cold transferred inbound calls fixtures
** check visualizations in all analytics call tables and call detail page
* exports won’t contain initial Agent - to be checked for regressions
* real-time tab won’t be touched

---

### [DSH-5653: [FE] AN call tables & call detail outbound cold transfer](https://cloudtalk.atlassian.net//browse/DSH-5653)

**Type:** Story

*ED*

* call tables:
** apply new visualization from [figma|https://www.figma.com/design/4Cm1MRoC0xv2l0im2BZ0FZ/WIP-Analytics?node-id=5413-22361&t=UwMoxpRyAEh9CWrE-0] to calls with new {{type: cold_transfer}} on agent/group reports/Tag/AI analytics and call log
** after inbound cold transfer FE support implementation this should “just” be about:
*** show outbound cold transfer icon when {{type: cold_transfer}} & {{direction: outbound}}
*** change recording play button logic to:
**** show play widget (including download icon) foreach {{calls.recordingsCallIds = [ <first_cdr_id>, <second_cdr_id_if_outbound_cold_transfer>]}} from {{total-calls}}response 
**** add delete and download actions  foreach Id in {{recordingCallIds}} under three-dots option on call
* call detail
** show outbound cold transfer icon when {{type: cold_transfer}} & {{direction: outbound}}
** show recordings (including download and delete) per recording ID from {{calls.recordingsCallIds = [ <first_cdr_id>, <second_cdr_id_if_outbound_cold_transfer>]}} returned in {{calls/<id>}} response
* newly call recordings permission logic has to be changed to:
** if {{recorded:true}} → show recordings controls in UI for each ID in {{calls.recordingsCallIds}} (can be also empty depending on applied permissions from BE)

---

### [DSH-5640: [QA] AN outbound cold transfer e2e tests](https://cloudtalk.atlassian.net//browse/DSH-5640)

**Type:** Story

* consider writing e2e tests
** create cold transferred outbound calls fixtures
*** single call in metrics
*** the difference between inbound and outbound is that outbound has 2 recordings
** check visualizations in all analytics call tables and call detail page
* exports won’t contain initial Agent - to be checked for regressions
* real-time tab won’t be touched

---

### [DSH-5792: [FE] Warm transferred calls](https://cloudtalk.atlassian.net//browse/DSH-5792)

**Type:** Story

-FE (rough estimate 8SP)-

* -based on- [-figma-|https://www.figma.com/design/4Cm1MRoC0xv2l0im2BZ0FZ/WIP-Analytics?node-id=5139-13660&p=f&t=SLpfGZpVTvTfb9c9-0] -show on all AN pages with call tables expandable call row(s) for warm transferred calls where an internal call will be visible with all details-
* -enhance call details page based on figma- 



Simplified FE alternative (estimate: 3)

* based on [https://www.figma.com/design/4Cm1MRoC0xv2l0im2BZ0FZ/WIP-Analytics?node-id=5664-38148&t=7N9ESKVcI29HbrJw-0|https://www.figma.com/design/4Cm1MRoC0xv2l0im2BZ0FZ/WIP-Analytics?node-id=5664-38148&t=7N9ESKVcI29HbrJw-0|smart-link] internal call of a warm transfer call has its own row on the call table (instead of internal call of a warm transfer call being included in the warm transfer call row in the call table)
** No more collapsing behavior for warm transfer call to see the internal call
** No more ‘Related internal calls’ section in the Call Details page
** just hint on the in/out call icon with related internal call ID (will be provided by BE)

---

### [DSH-5792 (comment by Arnaldo Tema)](https://cloudtalk.atlassian.net//browse/DSH-5792 (comment by Arnaldo Tema))

**Type:** Story

 moved this back to ready for ED as I’m not sure checklist items were considered at the time (ie UI testing, events, etc)
nvm, just saw the separate e2e tests ticket


---

### [DSH-5793: [QA] Warm transferred calls](https://cloudtalk.atlassian.net//browse/DSH-5793)

**Type:** Story

QA (5 SP)

* e2e tests:
** prepare fixtures for warm transferred inbound/outbound calls
** check proper visualization is whon on all call tables and call details page

---

</details>

## Dependencies

### [DSH-5655: [BE] Warm transferred calls](https://cloudtalk.atlassian.net//browse/DSH-5655)

**Type:** Story

has to be created-

---

